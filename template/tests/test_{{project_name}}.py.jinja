import json
from unittest.mock import MagicMock

import structlog

from {{project_name}} import __version__
from {{project_name}} import main as entrypoint
from {{project_name}}.log_config import configure_logging


def test_main_logs_version(monkeypatch):
    mock_config = MagicMock()
    monkeypatch.setattr("{{project_name}}.main.configure_logging", mock_config)

    with structlog.testing.capture_logs() as captured:
        entrypoint.main()

    assert mock_config.called
    assert len(captured) == 1
    log_event = captured[0]
    assert log_event["log_level"] == "info"
    assert log_event["event"] == "{{project_name}}"
    assert log_event["version"] == f"v{__version__}"


def test_logging_configuration_console_on_tty(monkeypatch):
    mock_configure = MagicMock()
    monkeypatch.setattr("structlog.configure", mock_configure)
    monkeypatch.setattr("sys.stderr.isatty", lambda: True)

    configure_logging()

    assert mock_configure.called
    _, kwargs = mock_configure.call_args
    assert isinstance(kwargs["processors"][-1], structlog.dev.ConsoleRenderer)


def test_logging_configuration_json_on_non_tty(monkeypatch):
    mock_configure = MagicMock()
    monkeypatch.setattr("structlog.configure", mock_configure)
    monkeypatch.setattr("sys.stderr.isatty", lambda: False)

    configure_logging()

    assert mock_configure.called
    _, kwargs = mock_configure.call_args
    assert isinstance(kwargs["processors"][-1], structlog.processors.JSONRenderer)


def test_logging_output_is_json_on_non_tty(monkeypatch):
    """Test that log output is JSON when not in a TTY."""
    mock_configure = MagicMock()
    monkeypatch.setattr("structlog.configure", mock_configure)
    monkeypatch.setattr("sys.stderr.isatty", lambda: False)

    configure_logging()

    assert mock_configure.called
    _, kwargs = mock_configure.call_args
    renderer = kwargs["processors"][-1]

    log_output = renderer(None, None, {"event": "test_event", "key": "value"})
    event_data = json.loads(log_output)

    assert event_data["event"] == "test_event"
    assert event_data["key"] == "value"
