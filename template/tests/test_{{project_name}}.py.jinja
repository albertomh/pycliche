import json
from importlib.metadata import version

import structlog

from {{project_name}} import main as entrypoint
from {{project_name}}.log_config import configure_logging


def test_main_logs_version():
    with structlog.testing.capture_logs() as captured:
        entrypoint.main()

    assert len(captured) == 1
    log_event = captured[0]
    assert log_event["log_level"] == "info"
    assert log_event["event"] == "{{project_name}}"
    assert log_event["version"] == f"v{version('{{project_name}}')}"


def test_logging_configuration_console_on_tty(monkeypatch):
    monkeypatch.setattr("sys.stderr.isatty", lambda: True)
    configure_logging()
    config = structlog.get_config()
    assert isinstance(config["processors"][-1], structlog.dev.ConsoleRenderer)


def test_logging_configuration_json_on_non_tty(monkeypatch):
    monkeypatch.setattr("sys.stderr.isatty", lambda: False)
    configure_logging()
    config = structlog.get_config()
    assert isinstance(config["processors"][-1], structlog.processors.JSONRenderer)


def test_logging_output_is_json_on_non_tty(monkeypatch):
    """Test that log output is JSON when not in a TTY."""
    monkeypatch.setattr("sys.stderr.isatty", lambda: False)
    configure_logging()

    capturing_logger = structlog.testing.CapturingLogger()
    structlog.configure(logger_factory=lambda: capturing_logger)

    logger = structlog.get_logger()
    logger.info("test_event", key="value")

    assert len(capturing_logger.calls) == 1
    call = capturing_logger.calls[0]
    method_name, event_tuple, _ = call
    event_data = json.loads(event_tuple[0])

    assert method_name == "info"
    assert event_data["event"] == "test_event"
    assert event_data["key"] == "value"
